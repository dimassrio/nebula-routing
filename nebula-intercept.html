<script>
(function() {

  window.Nebula = window.Nebula || {}
  Nebula.Routing = Nebula.Routing || {}

  Nebula.Routing.intercept = function(e) {

    // if the default has already been prevented then ignore
    if (e.defaultPrevented) return

    // only left clicks with no special keys
    if (event.button !== 0 || event.metaKey || event.ctrlKey) return    

    // sometimes other elements are wrapped in an A link, loop through the event
    // path looking for an A link
    let anchor
    for (let i=0; i < e.path.length; i++) {
      let el = e.path[i]
      if (el.nodeName === 'A' && el.href) {
        anchor = el
        break;
      }
    }

    // ignore event if no A link
    if (!anchor) return

    // ignore links not targeted at self
    if (anchor.target && anchor.target !== '_self') return
    
    // ignore routes that are not same origin
    const url = new URL(anchor.href)
    if (url.origin !== window.location.origin) return

    // ignore routes that are tagged for ignore
    const routing = (anchor.dataset && typeof anchor.dataset.routing === 'string') ? anchor.dataset.routing.toLowerCase() : void(0)
    if (routing && routing === 'ignore') return

    // intercept event
    e.preventDefault()

    // if the data-route attribute specifies a replace state then do a replace
    if (routing && routing === "replace") {
      history.replaceState(null, null, anchor.href)
    } else {
      history.pushState(null, null, anchor.href)
    }

    window.dispatchEvent(new PopStateEvent('popstate'))
  }

  window.addEventListener('click', Nebula.Routing.intercept)
}())
</script>
